<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech254 Passport Photo Sizer Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #e0e7ff;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --danger-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --dark-color: #2b2d42;
            --light-color: #f8f9fa;
            --gray-color: #adb5bd;
            --border-radius: 12px;
            --box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7ff;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .brand {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 2px dashed var(--gray-color);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: var(--transition);
            background-color: var(--light-color);
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        .upload-area i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .upload-area p {
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        
        .upload-area.active {
            border-color: var(--success-color);
            background-color: rgba(76, 201, 240, 0.1);
        }
        
        #photoUpload {
            display: none;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        
        .control-group input, 
        .control-group select {
            padding: 10px 12px;
            border: 1px solid var(--gray-color);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }
        
        .control-group input:focus, 
        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        input[type="color"] {
            height: 40px;
            padding: 3px;
            cursor: pointer;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: var(--gray-color);
            border-radius: 5px;
            margin-top: 8px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #3a7bc8;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3ab7d9;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #e5177e;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e68a19;
        }
        
        .btn-dark {
            background-color: var(--dark-color);
            color: white;
        }
        
        .btn-dark:hover {
            background-color: #1a1b2e;
        }
        
        .btn-light {
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .btn-light:hover {
            background-color: #e9ecef;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.85rem;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-group-center {
            justify-content: center;
        }
        
        canvas {
            max-width: 100%;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-color);
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .preview-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 400px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .a4-template {
            width: 210mm;
            height: 297mm;
            background-color: white;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            page-break-after: always;
        }
        
        .photo-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .draggable-photo {
            position: absolute;
            cursor: move;
            user-select: none;
            box-sizing: border-box;
            transition: var(--transition);
        }
        
        .draggable-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .photo-controls {
            position: absolute;
            top: -30px;
            left: 0;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: var(--transition);
        }
        
        .draggable-photo:hover .photo-controls {
            opacity: 1;
        }
        
        .photo-control-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .photo-control-btn:hover {
            transform: scale(1.1);
        }
        
        .photo-control-btn.delete {
            background-color: var(--danger-color);
        }
        
        .photo-control-btn.duplicate {
            background-color: var(--success-color);
        }
        
        .photo-control-btn.rotate {
            background-color: var(--warning-color);
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .a4-template, .a4-template * {
                visibility: visible;
            }
            .a4-template {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                height: 297mm;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none;
            }
            .photo-controls {
                display: none;
            }
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 15px 0 10px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .border-controls {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }
        
        .bg-removal-tool {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }
        
        .history-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-message i {
            font-size: 1.2rem;
        }
        
        .success {
            background-color: rgba(76, 201, 240, 0.1);
            color: #155724;
            border-left: 4px solid var(--success-color);
        }
        
        .error {
            background-color: rgba(247, 37, 133, 0.1);
            color: #721c24;
            border-left: 4px solid var(--danger-color);
        }
        
        .layout-options {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Cropper styles */
        .cropper-container {
            max-width: 100%;
            margin: 15px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .cropper-modal {
            background: transparent;
        }
        
        .cropper-view-box {
            outline: 2px solid var(--primary-color);
            outline-color: rgba(67, 97, 238, 0.75);
        }
        
        .cropper-dashed {
            border-color: var(--primary-color);
        }
        
        .cropper-point {
            background-color: var(--primary-color);
        }
        
        .cropper-line {
            background-color: var(--primary-color);
        }
        
        /* Ruler styles */
        .ruler {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .horizontal-ruler {
            top: 0;
            left: 0;
            width: 100%;
            height: 25px;
            border-bottom: 1px solid var(--gray-color);
        }
        
        .vertical-ruler {
            top: 0;
            left: 0;
            width: 25px;
            height: 100%;
            border-right: 1px solid var(--gray-color);
        }
        
        .ruler-marker {
            position: absolute;
            background-color: var(--gray-color);
        }
        
        .horizontal-marker {
            width: 1px;
            height: 7px;
        }
        
        .vertical-marker {
            width: 7px;
            height: 1px;
        }
        
        .ruler-label {
            position: absolute;
            font-size: 10px;
            color: var(--dark-color);
            font-weight: 500;
        }
        
        /* Crop controls */
        .crop-controls {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }
        
        /* Alignment guides */
        .alignment-guide {
            position: absolute;
            background-color: rgba(67, 97, 238, 0.5);
            z-index: 90;
            pointer-events: none;
            display: none;
        }
        
        .horizontal-guide {
            width: 100%;
            height: 1px;
        }
        
        .vertical-guide {
            width: 1px;
            height: 100%;
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark-color) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Progress bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: var(--light-color);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* Animation for file upload */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .upload-area.uploading {
            animation: pulse 1.5s infinite;
        }
        
        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
            transition: var(--transition);
        }
        
        .fab:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px) scale(1.1);
        }
        
        /* Dark mode toggle */
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-color);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        
        body.dark-mode .card {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        
        body.dark-mode .card h2 {
            color: var(--accent-color);
        }
        
        body.dark-mode .upload-area {
            background-color: #2d2d2d;
            border-color: #444;
        }
        
        body.dark-mode .control-group input,
        body.dark-mode .control-group select {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }
        
        body.dark-mode .border-controls,
        body.dark-mode .bg-removal-tool {
            background-color: #2d2d2d;
        }
        
        body.dark-mode .a4-template {
            background-color: #1e1e1e;
        }
        
        body.dark-mode .ruler {
            background-color: rgba(30, 30, 30, 0.9);
        }
        
        body.dark-mode .ruler-label {
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="dark-mode-toggle">
        <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider"></span>
        </label>
    </div>

    <div class="container">
        <header>
            <h1>Passport Photo Sizer Tool</h1>
            <div class="brand">
                <i class="fas fa-camera"></i>
                <span>By Meta Tech254 Sizer</span>
            </div>
        </header>
        
        <div class="app-container">
            <div class="upload-section">
                <div class="card">
                    <h2><i class="fas fa-upload"></i> Upload Your Photo</h2>
                    
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag & drop your photo here or click to browse</p>
                        <button class="btn btn-primary" id="uploadButton">
                            <i class="fas fa-folder-open"></i> Select File
                        </button>
                        <input type="file" id="photoUpload" accept="image/*">
                    </div>
                    
                    <div class="crop-controls" style="display: none;">
                        <h3 class="section-title"><i class="fas fa-crop-alt"></i> Crop Image</h3>
                        <div id="cropper-container">
                            <img id="cropper-image" style="max-width: 100%;">
                        </div>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button id="crop-btn" class="btn btn-success">
                                <i class="fas fa-check"></i> Apply Crop
                            </button>
                            <button id="cancel-crop-btn" class="btn btn-danger">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="section-title"><i class="fas fa-ruler-combined"></i> Photo Dimensions</h3>
                    <div class="controls">
                        <div class="control-group">
                            <label for="photoWidth">Width (mm):</label>
                            <input type="number" id="photoWidth" value="35" min="10" max="100">
                        </div>
                        
                        <div class="control-group">
                            <label for="photoHeight">Height (mm):</label>
                            <input type="number" id="photoHeight" value="45" min="10" max="100">
                        </div>
                        
                        <div class="control-group">
                            <label for="bgColor">Background:</label>
                            <input type="color" id="bgColor" value="#ffffff">
                        </div>
                        
                        <div class="control-group">
                            <label for="copiesCount">Copies:</label>
                            <input type="number" id="copiesCount" value="4" min="1" max="20">
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button id="resizeBtn" class="btn btn-primary">
                            <i class="fas fa-expand"></i> Resize Photo
                        </button>
                        <button id="crop-tool-btn" class="btn btn-secondary">
                            <i class="fas fa-crop-alt"></i> Crop Tool
                        </button>
                    </div>
                    
                    <canvas id="photoCanvas"></canvas>
                    
                    <div class="border-controls">
                        <h3 class="section-title"><i class="fas fa-border-style"></i> Border Settings</h3>
                        <div class="controls">
                            <div class="control-group">
                                <label for="borderSize">Size (mm): <span id="borderSizeValue">0.2</span></label>
                                <input type="range" id="borderSize" min="0" max="2" step="0.1" value="0.2">
                            </div>
                            
                            <div class="control-group">
                                <label for="borderColor">Color:</label>
                                <input type="color" id="borderColor" value="#cccccc">
                            </div>
                            
                            <div class="control-group">
                                <label for="borderType">Style:</label>
                                <select id="borderType" class="btn btn-light">
                                    <option value="solid">Solid</option>
                                    <option value="dashed" selected>Dashed</option>
                                    <option value="dotted">Dotted</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-removal-tool">
                        <h3 class="section-title"><i class="fas fa-magic"></i> Metasploit Tech 254 Background Removal</h3>
                        <p>Automatically remove background with Metasploit Tech 254</p>
                        <div class="bg-removal-controls">
                            <button id="removeBgBtn" class="btn btn-warning">
                                <span id="removeBgText"><i class="fas fa-robot"></i> Remove Background</span>
                                <span id="removeBgSpinner" class="loading" style="display:none;"></span>
                            </button>
                            <button id="resetBgBtn" class="btn btn-light">
                                <i class="fas fa-undo"></i> Reset Image
                            </button>
                        </div>
                        <div class="progress-container" style="display: none;">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="history-controls">
                            <button id="undoBtn" class="btn btn-light" disabled>
                                <i class="fas fa-undo"></i> Undo
                            </button>
                            <button id="redoBtn" class="btn btn-light" disabled>
                                <i class="fas fa-redo"></i> Redo
                            </button>
                        </div>
                        <div id="statusMessage" class="status-message" style="display:none;"></div>
                    </div>
                </div>
            </div>
            
            <div class="preview-section">
                <div class="card">
                    <h2><i class="fas fa-print"></i> A4 Print Preview (<span id="copiesCountDisplay">4</span> copies)</h2>
                    
                    <div class="layout-options no-print">
                        <button id="autoLayoutBtn" class="btn btn-success active">
                            <i class="fas fa-magic"></i> Auto Layout
                        </button>
                        <button id="manualLayoutBtn" class="btn btn-secondary">
                            <i class="fas fa-hand-paper"></i> Manual
                        </button>
                        <button id="gridLayoutBtn" class="btn btn-secondary">
                            <i class="fas fa-th"></i> Grid
                        </button>
                        <button id="toggleRulerBtn" class="btn btn-light">
                            <i class="fas fa-ruler"></i> Ruler
                        </button>
                        <button id="addGuideBtn" class="btn btn-light">
                            <i class="fas fa-plus"></i> Guide
                        </button>
                    </div>
                    
                    <div class="preview-container">
                        <div class="a4-template" id="a4Template">
                            <div id="horizontalRuler" class="ruler horizontal-ruler" style="display: none;"></div>
                            <div id="verticalRuler" class="ruler vertical-ruler" style="display: none;"></div>
                            <div class="photo-container" id="photoContainer">
                                <!-- Alignment guides -->
                                <div id="horizontalGuide" class="alignment-guide horizontal-guide"></div>
                                <div id="verticalGuide" class="alignment-guide vertical-guide"></div>
                                <!-- Photos will be inserted here as draggable elements -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="btn-group btn-group-center no-print" style="margin-top: 20px;">
                        <button id="downloadPdfBtn" class="btn btn-danger">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button id="downloadPngBtn" class="btn btn-primary">
                            <i class="fas fa-file-image"></i> PNG
                        </button>
                        <button id="downloadJpgBtn" class="btn btn-primary">
                            <i class="fas fa-file-image"></i> JPG
                        </button>
                        <button id="downloadDocxBtn" class="btn btn-dark">
                            <i class="fas fa-file-word"></i> DOCX
                        </button>
                        <button id="printBtn" class="btn btn-warning">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fab no-print" id="helpFab">
        <i class="fas fa-question"></i>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const photoUpload = document.getElementById('photoUpload');
            const uploadArea = document.getElementById('uploadArea');
            const uploadButton = document.getElementById('uploadButton');
            const photoCanvas = document.getElementById('photoCanvas');
            const ctx = photoCanvas.getContext('2d');
            const photoWidthInput = document.getElementById('photoWidth');
            const photoHeightInput = document.getElementById('photoHeight');
            const bgColorInput = document.getElementById('bgColor');
            const copiesCountInput = document.getElementById('copiesCount');
            const copiesCountDisplay = document.getElementById('copiesCountDisplay');
            const resizeBtn = document.getElementById('resizeBtn');
            const removeBgBtn = document.getElementById('removeBgBtn');
            const removeBgText = document.getElementById('removeBgText');
            const removeBgSpinner = document.getElementById('removeBgSpinner');
            const resetBgBtn = document.getElementById('resetBgBtn');
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            const photoContainer = document.getElementById('photoContainer');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const downloadPngBtn = document.getElementById('downloadPngBtn');
            const downloadJpgBtn = document.getElementById('downloadJpgBtn');
            const downloadDocxBtn = document.getElementById('downloadDocxBtn');
            const printBtn = document.getElementById('printBtn');
            const statusMessage = document.getElementById('statusMessage');
            const autoLayoutBtn = document.getElementById('autoLayoutBtn');
            const manualLayoutBtn = document.getElementById('manualLayoutBtn');
            const gridLayoutBtn = document.getElementById('gridLayoutBtn');
            const cropToolBtn = document.getElementById('crop-tool-btn');
            const cropControls = document.querySelector('.crop-controls');
            const cropperImage = document.getElementById('cropper-image');
            const cropBtn = document.getElementById('crop-btn');
            const cancelCropBtn = document.getElementById('cancel-crop-btn');
            const toggleRulerBtn = document.getElementById('toggleRulerBtn');
            const horizontalRuler = document.getElementById('horizontalRuler');
            const verticalRuler = document.getElementById('verticalRuler');
            const addGuideBtn = document.getElementById('addGuideBtn');
            const horizontalGuide = document.getElementById('horizontalGuide');
            const verticalGuide = document.getElementById('verticalGuide');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.querySelector('.progress-container');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const helpFab = document.getElementById('helpFab');
            
            // Border controls
            const borderSizeInput = document.getElementById('borderSize');
            const borderColorInput = document.getElementById('borderColor');
            const borderTypeInput = document.getElementById('borderType');
            const borderSizeValue = document.getElementById('borderSizeValue');
            
            // State variables
            let originalImage = null;
            let currentImageData = null;
            let resizedImageUrl = null;
            let currentBorderSize = 0.2;
            let currentBorderColor = '#cccccc';
            let currentBorderType = 'dashed';
            let currentLayoutMode = 'auto'; // 'auto', 'manual', 'grid'
            let draggablePhotos = [];
            let cropper = null;
            let guides = [];
            let isRulerVisible = false;
            let snapThreshold = 5; // pixels threshold for snapping
            let isSnapping = false;
            let historyStack = [];
            let currentHistoryIndex = -1;
            const MAX_HISTORY = 20;
            
            // Initialize the app
            function init() {
                // Initialize event listeners
                setupEventListeners();
                
                // Initialize rulers
                initRulers();
                
                // Initialize with auto layout
                setLayoutMode('auto');
                
                // Check for dark mode preference
                if (localStorage.getItem('darkMode') === 'enabled') {
                    document.body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                }
            }
            
            // Set up all event listeners
            function setupEventListeners() {
                // File upload
                uploadButton.addEventListener('click', () => photoUpload.click());
                uploadArea.addEventListener('click', () => photoUpload.click());
                photoUpload.addEventListener('change', handleFileUpload);
                
                // Drag and drop
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('active');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('active');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('active');
                    if (e.dataTransfer.files.length) {
                        photoUpload.files = e.dataTransfer.files;
                        handleFileUpload();
                    }
                });
                
                // Photo controls
                copiesCountInput.addEventListener('input', updateCopiesCountDisplay);
                borderSizeInput.addEventListener('input', updateBorderSize);
                borderColorInput.addEventListener('input', updateBorderColor);
                borderTypeInput.addEventListener('change', updateBorderType);
                resizeBtn.addEventListener('click', resizePhoto);
                cropToolBtn.addEventListener('click', toggleCropTool);
                cropBtn.addEventListener('click', applyCrop);
                cancelCropBtn.addEventListener('click', cancelCrop);
                
                // Background removal
                removeBgBtn.addEventListener('click', removeBackground);
                resetBgBtn.addEventListener('click', resetBackground);
                undoBtn.addEventListener('click', undoAction);
                redoBtn.addEventListener('click', redoAction);
                
                // Layout controls
                autoLayoutBtn.addEventListener('click', () => setLayoutMode('auto'));
                manualLayoutBtn.addEventListener('click', () => setLayoutMode('manual'));
                gridLayoutBtn.addEventListener('click', () => setLayoutMode('grid'));
                toggleRulerBtn.addEventListener('click', toggleRulers);
                addGuideBtn.addEventListener('click', () => addGuide(true));
                
                // Download/print controls
                downloadPdfBtn.addEventListener('click', downloadPDF);
                downloadPngBtn.addEventListener('click', downloadPNG);
                downloadJpgBtn.addEventListener('click', downloadJPG);
                downloadDocxBtn.addEventListener('click', downloadDOCX);
                printBtn.addEventListener('click', printDocument);
                
                // Dark mode toggle
                darkModeToggle.addEventListener('change', toggleDarkMode);
                
                // Help button
                helpFab.addEventListener('click', showHelp);
            }
            
            // Handle file upload
            function handleFileUpload() {
                if (photoUpload.files && photoUpload.files[0]) {
                    uploadArea.classList.add('uploading');
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        originalImage = new Image();
                        originalImage.onload = function() {
                            photoCanvas.width = originalImage.width;
                            photoCanvas.height = originalImage.height;
                            ctx.drawImage(originalImage, 0, 0);
                            
                            // Save initial state to history
                            saveState();
                            
                            uploadArea.classList.remove('uploading');
                            uploadArea.innerHTML = `
                                <i class="fas fa-check-circle" style="color: var(--success-color); font-size: 2.5rem;"></i>
                                <p>Photo uploaded successfully!</p>
                            `;
                            
                            showStatus('<i class="fas fa-check-circle"></i> Photo uploaded successfully!', 'success');
                        };
                        originalImage.onerror = function() {
                            uploadArea.classList.remove('uploading');
                            uploadArea.innerHTML = `
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Drag & drop your photo here or click to browse</p>
                                <button class="btn btn-primary" id="uploadButton">
                                    <i class="fas fa-folder-open"></i> Select File
                                </button>
                            `;
                            showStatus('<i class="fas fa-exclamation-circle"></i> Failed to load image', 'error');
                        };
                        originalImage.src = event.target.result;
                    };
                    
                    reader.onerror = function() {
                        uploadArea.classList.remove('uploading');
                        showStatus('<i class="fas fa-exclamation-circle"></i> Error reading file', 'error');
                    };
                    
                    reader.readAsDataURL(photoUpload.files[0]);
                }
            }
            
            // Update copies count display
            function updateCopiesCountDisplay() {
                copiesCountDisplay.textContent = copiesCountInput.value;
                if (resizedImageUrl) updateA4Template();
            }
            
            // Update border size
            function updateBorderSize() {
                currentBorderSize = parseFloat(borderSizeInput.value);
                borderSizeValue.textContent = currentBorderSize.toFixed(1);
                if (resizedImageUrl) updatePhotoBorders();
            }
            
            // Update border color
            function updateBorderColor() {
                currentBorderColor = borderColorInput.value;
                if (resizedImageUrl) updatePhotoBorders();
            }
            
            // Update border type
            function updateBorderType() {
                currentBorderType = borderTypeInput.value;
                if (resizedImageUrl) updatePhotoBorders();
            }
            
            // Initialize rulers
            function initRulers() {
                // Horizontal ruler
                for (let i = 0; i <= 210; i += 10) {
                    const marker = document.createElement('div');
                    marker.className = 'ruler-marker horizontal-marker';
                    marker.style.left = `${i}mm`;
                    marker.style.bottom = '0';
                    
                    if (i % 50 === 0) {
                        marker.style.height = '12px';
                        const label = document.createElement('div');
                        label.className = 'ruler-label';
                        label.textContent = i;
                        label.style.left = `${i-5}mm`;
                        label.style.bottom = '-18px';
                        horizontalRuler.appendChild(label);
                    } else if (i % 10 === 0) {
                        marker.style.height = '8px';
                    }
                    
                    horizontalRuler.appendChild(marker);
                }
                
                // Vertical ruler
                for (let i = 0; i <= 297; i += 10) {
                    const marker = document.createElement('div');
                    marker.className = 'ruler-marker vertical-marker';
                    marker.style.top = `${i}mm`;
                    marker.style.right = '0';
                    
                    if (i % 50 === 0) {
                        marker.style.width = '12px';
                        const label = document.createElement('div');
                        label.className = 'ruler-label';
                        label.textContent = i;
                        label.style.top = `${i-5}mm`;
                        label.style.right = '-18px';
                        verticalRuler.appendChild(label);
                    } else if (i % 10 === 0) {
                        marker.style.width = '8px';
                    }
                    
                    verticalRuler.appendChild(marker);
                }
            }
            
            // Toggle ruler visibility
            function toggleRulers() {
                isRulerVisible = !isRulerVisible;
                if (isRulerVisible) {
                    horizontalRuler.style.display = 'block';
                    verticalRuler.style.display = 'block';
                    toggleRulerBtn.innerHTML = '<i class="fas fa-ruler"></i> Hide Ruler';
                } else {
                    horizontalRuler.style.display = 'none';
                    verticalRuler.style.display = 'none';
                    toggleRulerBtn.innerHTML = '<i class="fas fa-ruler"></i> Show Ruler';
                }
            }
            
            // Add alignment guide
            function addGuide(isHorizontal = true) {
                const guideId = Date.now();
                const guide = document.createElement('div');
                guide.className = `guide ${isHorizontal ? 'horizontal-guide' : 'vertical-guide'}`;
                guide.id = `guide-${guideId}`;
                
                if (isHorizontal) {
                    guide.style.top = '50%';
                    guide.style.left = '0';
                } else {
                    guide.style.left = '50%';
                    guide.style.top = '0';
                }
                
                const handle = document.createElement('div');
                handle.className = 'guide-handle';
                handle.style.left = isHorizontal ? '50%' : '5px';
                handle.style.top = isHorizontal ? '5px' : '50%';
                
                guide.appendChild(handle);
                document.getElementById('a4Template').appendChild(guide);
                
                guides.push({
                    id: guideId,
                    element: guide,
                    isHorizontal,
                    position: isHorizontal ? 148.5 : 105 // Middle of A4
                });
                
                // Make draggable
                let isDragging = false;
                let startPos;
                
                handle.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startPos = isHorizontal ? e.clientY : e.clientX;
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const containerRect = document.getElementById('a4Template').getBoundingClientRect();
                    const newPos = isHorizontal ? 
                        (e.clientY - containerRect.top) / (containerRect.height / 297) :
                        (e.clientX - containerRect.left) / (containerRect.width / 210);
                    
                    // Constrain to container
                    const constrainedPos = Math.max(0, Math.min(isHorizontal ? 297 : 210, newPos));
                    
                    if (isHorizontal) {
                        guide.style.top = `${constrainedPos}mm`;
                        handle.style.top = '5px';
                    } else {
                        guide.style.left = `${constrainedPos}mm`;
                        handle.style.left = '5px';
                    }
                    
                    // Update position in guides array
                    const guideIndex = guides.findIndex(g => g.id === guideId);
                    if (guideIndex !== -1) {
                        guides[guideIndex].position = constrainedPos;
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }
            
            // Check for alignment with other photos and show guides
            function checkAlignment(x, y, width, height, currentId) {
                // Hide guides initially
                horizontalGuide.style.display = 'none';
                verticalGuide.style.display = 'none';
                isSnapping = false;
                
                // Check alignment with other photos
                for (const photo of draggablePhotos) {
                    if (photo.id === currentId) continue;
                    
                    // Convert positions to pixels for comparison
                    const containerRect = photoContainer.getBoundingClientRect();
                    const pxPerMMX = containerRect.width / 210;
                    const pxPerMMY = containerRect.height / 297;
                    
                    const currentLeftPx = x * pxPerMMX;
                    const currentTopPx = y * pxPerMMY;
                    const currentRightPx = (x + width) * pxPerMMX;
                    const currentBottomPx = (y + height) * pxPerMMY;
                    
                    const photoLeftPx = photo.x * pxPerMMX;
                    const photoTopPx = photo.y * pxPerMMY;
                    const photoRightPx = (photo.x + photo.width) * pxPerMMX;
                    const photoBottomPx = (photo.y + photo.height) * pxPerMMY;
                    
                    // Check horizontal alignment (top, center, bottom)
                    if (Math.abs(currentTopPx - photoTopPx) < snapThreshold) {
                        // Snap to top
                        y = photo.y;
                        horizontalGuide.style.top = `${photo.y}mm`;
                        horizontalGuide.style.display = 'block';
                        isSnapping = true;
                    } else if (Math.abs(currentBottomPx - photoBottomPx) < snapThreshold) {
                        // Snap to bottom
                        y = photo.y + photo.height - height;
                        horizontalGuide.style.top = `${photo.y + photo.height}mm`;
                        horizontalGuide.style.display = 'block';
                        isSnapping = true;
                    } else if (Math.abs((currentTopPx + currentBottomPx)/2 - (photoTopPx + photoBottomPx)/2) < snapThreshold) {
                        // Snap to vertical center
                        y = photo.y + (photo.height - height)/2;
                        horizontalGuide.style.top = `${photo.y + photo.height/2}mm`;
                        horizontalGuide.style.display = 'block';
                        isSnapping = true;
                    }
                    
                    // Check vertical alignment (left, center, right)
                    if (Math.abs(currentLeftPx - photoLeftPx) < snapThreshold) {
                        // Snap to left
                        x = photo.x;
                        verticalGuide.style.left = `${photo.x}mm`;
                        verticalGuide.style.display = 'block';
                        isSnapping = true;
                    } else if (Math.abs(currentRightPx - photoRightPx) < snapThreshold) {
                        // Snap to right
                        x = photo.x + photo.width - width;
                        verticalGuide.style.left = `${photo.x + photo.width}mm`;
                        verticalGuide.style.display = 'block';
                        isSnapping = true;
                    } else if (Math.abs((currentLeftPx + currentRightPx)/2 - (photoLeftPx + photoRightPx)/2) < snapThreshold) {
                        // Snap to horizontal center
                        x = photo.x + (photo.width - width)/2;
                        verticalGuide.style.left = `${photo.x + photo.width/2}mm`;
                        verticalGuide.style.display = 'block';
                        isSnapping = true;
                    }
                }
                
                // Check alignment with page center
                const containerRect = photoContainer.getBoundingClientRect();
                const pxPerMMX = containerRect.width / 210;
                const pxPerMMY = containerRect.height / 297;
                
                const currentCenterXPx = (x + width/2) * pxPerMMX;
                const currentCenterYPx = (y + height/2) * pxPerMMY;
                const pageCenterXPx = 105 * pxPerMMX;
                const pageCenterYPx = 148.5 * pxPerMMY;
                
                if (Math.abs(currentCenterXPx - pageCenterXPx) < snapThreshold) {
                    // Snap to horizontal center of page
                    x = 105 - width/2;
                    verticalGuide.style.left = '105mm';
                    verticalGuide.style.display = 'block';
                    isSnapping = true;
                }
                
                if (Math.abs(currentCenterYPx - pageCenterYPx) < snapThreshold) {
                    // Snap to vertical center of page
                    y = 148.5 - height/2;
                    horizontalGuide.style.top = '148.5mm';
                    horizontalGuide.style.display = 'block';
                    isSnapping = true;
                }
                
                return { x, y };
            }
            
            // Toggle crop tool
            function toggleCropTool() {
                if (!originalImage) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please upload a photo first', 'error');
                    return;
                }
                
                // Show crop controls
                cropControls.style.display = 'block';
                cropperImage.src = photoCanvas.toDataURL();
                
                // Initialize cropper
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(cropperImage, {
                    aspectRatio: parseFloat(photoWidthInput.value) / parseFloat(photoHeightInput.value),
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false
                });
            }
            
            // Apply crop
            function applyCrop() {
                if (!cropper) return;
                
                // Get cropped canvas
                const croppedCanvas = cropper.getCroppedCanvas();
                
                // Update main canvas
                photoCanvas.width = croppedCanvas.width;
                photoCanvas.height = croppedCanvas.height;
                ctx.drawImage(croppedCanvas, 0, 0);
                
                // Save state
                saveState();
                
                // Hide crop controls
                cropControls.style.display = 'none';
                
                showStatus('<i class="fas fa-check-circle"></i> Image cropped successfully!', 'success');
            }
            
            // Cancel crop
            function cancelCrop() {
                cropControls.style.display = 'none';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }
            
            // Save current canvas state to history
            function saveState() {
                // Clear redo stack when making new changes
                historyStack = historyStack.slice(0, currentHistoryIndex + 1);
                
                // Limit history size
                if (historyStack.length >= MAX_HISTORY) {
                    historyStack.shift();
                } else {
                    currentHistoryIndex++;
                }
                
                // Save current image data
                historyStack.push({
                    imageData: ctx.getImageData(0, 0, photoCanvas.width, photoCanvas.height),
                    imageSrc: photoCanvas.toDataURL()
                });
                
                // Update button states
                updateUndoRedoButtons();
            }
            
            // Update undo/redo button states
            function updateUndoRedoButtons() {
                undoBtn.disabled = currentHistoryIndex <= 0;
                redoBtn.disabled = currentHistoryIndex >= historyStack.length - 1;
            }
            
            // Undo last action
            function undoAction() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    restoreState();
                }
            }
            
            // Redo last undone action
            function redoAction() {
                if (currentHistoryIndex < historyStack.length - 1) {
                    currentHistoryIndex++;
                    restoreState();
                }
            }
            
            // Restore state from history
            function restoreState() {
                const state = historyStack[currentHistoryIndex];
                ctx.putImageData(state.imageData, 0, 0);
                currentImageData = state.imageData;
                updateUndoRedoButtons();
            }
            
            // Remove background using AI (simulated API call)
            async function removeBackground() {
                if (!originalImage) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please upload a photo first', 'error');
                    return;
                }
                
                try {
                    // Show loading state
                    removeBgText.innerHTML = '<i class="fas fa-robot"></i> Processing...';
                    removeBgSpinner.style.display = 'inline-block';
                    removeBgBtn.disabled = true;
                    progressContainer.style.display = 'block';
                    statusMessage.style.display = 'none';
                    
                    // Save state before making changes
                    saveState();
                    
                    // Simulate progress
                    simulateProgress();
                    
                    // Simulate AI background removal (in a real app, you would call an API here)
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Create a temporary canvas for the "AI" processing
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = photoCanvas.width;
                    tempCanvas.height = photoCanvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Draw the original image
                    tempCtx.drawImage(photoCanvas, 0, 0);
                    
                    // Simulate AI processing by making a "best guess" at the background
                    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    const data = imageData.data;
                    
                    const centerX = Math.floor(tempCanvas.width / 2);
                    const centerY = Math.floor(tempCanvas.height / 2);
                    const edgeThreshold = 0.15; // 15% from edges is considered background
                    
                    for (let y = 0; y < tempCanvas.height; y++) {
                        for (let x = 0; x < tempCanvas.width; x++) {
                            const i = (y * tempCanvas.width + x) * 4;
                            
                            // Determine if pixel is likely background
                            const isEdge = 
                                x < tempCanvas.width * edgeThreshold ||
                                x > tempCanvas.width * (1 - edgeThreshold) ||
                                y < tempCanvas.height * edgeThreshold ||
                                y > tempCanvas.height * (1 - edgeThreshold);
                            
                            // Calculate distance from center
                            const distanceFromCenter = Math.sqrt(
                                Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2)
                            );
                            const maxDistance = Math.sqrt(
                                Math.pow(centerX, 2) + Math.pow(centerY, 2)
                            );
                            const normalizedDistance = distanceFromCenter / maxDistance;
                            
                            // If pixel is at edges or very different from center, make transparent
                            if (isEdge || normalizedDistance > 0.8) {
                                data[i + 3] = 0; // Set alpha to 0 (transparent)
                            }
                        }
                    }
                    
                    tempCtx.putImageData(imageData, 0, 0);
                    
                    // Draw the result back to main canvas
                    ctx.drawImage(tempCanvas, 0, 0);
                    currentImageData = ctx.getImageData(0, 0, photoCanvas.width, photoCanvas.height);
                    
                    showStatus('<i class="fas fa-check-circle"></i> Background removed successfully!', 'success');
                } catch (error) {
                    console.error('Background removal failed:', error);
                    showStatus('<i class="fas fa-exclamation-circle"></i> Background removal failed. Please try again.', 'error');
                } finally {
                    // Reset button state
                    removeBgText.innerHTML = '<i class="fas fa-robot"></i> Remove Background';
                    removeBgSpinner.style.display = 'none';
                    removeBgBtn.disabled = false;
                    progressContainer.style.display = 'none';
                }
            }
            
            // Simulate progress bar animation
            function simulateProgress() {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${Math.min(progress, 100)}%`;
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                    }
                }, 100);
            }
            
            // Reset image to original
            function resetBackground() {
                if (historyStack.length > 0) {
                    saveState(); // Save current state before resetting
                    currentHistoryIndex = 0;
                    restoreState();
                    showStatus('<i class="fas fa-check-circle"></i> Image reset to original', 'success');
                }
            }
            
            // Show status message
            function showStatus(message, type) {
                statusMessage.innerHTML = message;
                statusMessage.className = `status-message ${type}`;
                statusMessage.style.display = 'flex';
                
                // Hide after 5 seconds
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
            
            // Resize photo to passport size
            function resizePhoto() {
                if (!originalImage) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please upload a photo first', 'error');
                    return;
                }
                
                const widthMM = parseFloat(photoWidthInput.value);
                const heightMM = parseFloat(photoHeightInput.value);
                const bgColor = bgColorInput.value;
                
                // Calculate pixel dimensions at 300 DPI
                const pxPerMM = 300 / 25.4;
                const widthPx = Math.round(widthMM * pxPerMM);
                const heightPx = Math.round(heightMM * pxPerMM);
                
                // Create a temporary canvas for resizing
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = widthPx;
                tempCanvas.height = heightPx;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Fill with background color
                tempCtx.fillStyle = bgColor;
                tempCtx.fillRect(0, 0, widthPx, heightPx);
                
                // Calculate aspect ratio and position to center the image
                const originalAspect = originalImage.width / originalImage.height;
                const newAspect = widthPx / heightPx;
                
                let drawWidth, drawHeight, offsetX, offsetY;
                
                if (originalAspect > newAspect) {
                    // Original is wider than new aspect ratio
                    drawHeight = heightPx;
                    drawWidth = drawHeight * originalAspect;
                    offsetX = (widthPx - drawWidth) / 2;
                    offsetY = 0;
                } else {
                    // Original is taller than new aspect ratio
                    drawWidth = widthPx;
                    drawHeight = drawWidth / originalAspect;
                    offsetX = 0;
                    offsetY = (heightPx - drawHeight) / 2;
                }
                
                // Draw the image centered
                tempCtx.drawImage(photoCanvas, offsetX, offsetY, drawWidth, drawHeight);
                
                // Update the main canvas
                photoCanvas.width = widthPx;
                photoCanvas.height = heightPx;
                ctx.drawImage(tempCanvas, 0, 0);
                
                // Save the resized image URL
                resizedImageUrl = tempCanvas.toDataURL('image/jpeg', 0.9);
                
                // Update the A4 template
                updateA4Template();
                
                showStatus('<i class="fas fa-check-circle"></i> Photo resized successfully!', 'success');
            }
            
            // Update photo borders
            function updatePhotoBorders() {
                const photos = document.querySelectorAll('.draggable-photo');
                photos.forEach(photo => {
                    photo.style.border = `${currentBorderSize}mm ${currentBorderType} ${currentBorderColor}`;
                });
            }
            
            // Create a draggable photo element
            function createDraggablePhoto(id, x, y, width, height) {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'draggable-photo';
                photoDiv.id = `photo-${id}`;
                photoDiv.style.left = `${x}mm`;
                photoDiv.style.top = `${y}mm`;
                photoDiv.style.width = `${width}mm`;
                photoDiv.style.height = `${height}mm`;
                photoDiv.style.border = `${currentBorderSize}mm ${currentBorderType} ${currentBorderColor}`;
                
                const img = document.createElement('img');
                img.src = resizedImageUrl;
                img.alt = `Passport photo ${id}`;
                photoDiv.appendChild(img);
                
                // Add controls
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'photo-controls';
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'photo-control-btn delete';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Delete';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    photoDiv.remove();
                    draggablePhotos = draggablePhotos.filter(p => p.id !== id);
                });
                
                const cloneBtn = document.createElement('div');
                cloneBtn.className = 'photo-control-btn duplicate';
                cloneBtn.innerHTML = '+';
                cloneBtn.title = 'Duplicate';
                cloneBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newId = draggablePhotos.length > 0 ? Math.max(...draggablePhotos.map(p => p.id)) + 1 : 1;
                    createDraggablePhoto(newId, x + 5, y + 5, width, height);
                    draggablePhotos.push({
                        id: newId,
                        x: x + 5,
                        y: y + 5,
                        width,
                        height
                    });
                });
                
                const rotateBtn = document.createElement('div');
                rotateBtn.className = 'photo-control-btn rotate';
                rotateBtn.innerHTML = '↻';
                rotateBtn.title = 'Rotate';
                rotateBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentTransform = photoDiv.style.transform || '';
                    photoDiv.style.transform = currentTransform.includes('rotate(90deg)') ? 
                        currentTransform.replace('rotate(90deg)', '') : 
                        currentTransform + ' rotate(90deg)';
                });
                
                controlsDiv.appendChild(deleteBtn);
                controlsDiv.appendChild(cloneBtn);
                controlsDiv.appendChild(rotateBtn);
                photoDiv.appendChild(controlsDiv);
                
                // Make draggable
                let isDragging = false;
                let offsetX, offsetY;
                
                photoDiv.addEventListener('mousedown', (e) => {
                    if (e.target === photoDiv || e.target === img) {
                        isDragging = true;
                        offsetX = e.clientX - photoDiv.getBoundingClientRect().left;
                        offsetY = e.clientY - photoDiv.getBoundingClientRect().top;
                        photoDiv.style.zIndex = '100';
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const containerRect = photoContainer.getBoundingClientRect();
                    const containerLeft = containerRect.left;
                    const containerTop = containerRect.top;
                    
                    // Calculate position in mm
                    let newLeft = (e.clientX - containerLeft - offsetX) / (containerRect.width / 210);
                    let newTop = (e.clientY - containerTop - offsetY) / (containerRect.height / 297);
                    
                    // Check for alignment with other photos
                    const alignedPos = checkAlignment(newLeft, newTop, width, height, id);
                    newLeft = alignedPos.x;
                    newTop = alignedPos.y;
                    
                    // Constrain to container
                    const constrainedLeft = Math.max(0, Math.min(210 - width, newLeft));
                    const constrainedTop = Math.max(0, Math.min(297 - height, newTop));
                    
                    photoDiv.style.left = `${constrainedLeft}mm`;
                    photoDiv.style.top = `${constrainedTop}mm`;
                    
                    // Update position in draggablePhotos array
                    const photoIndex = draggablePhotos.findIndex(p => p.id === id);
                    if (photoIndex !== -1) {
                        draggablePhotos[photoIndex].x = constrainedLeft;
                        draggablePhotos[photoIndex].y = constrainedTop;
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    photoDiv.style.zIndex = '1';
                    horizontalGuide.style.display = 'none';
                    verticalGuide.style.display = 'none';
                });
                
                return photoDiv;
            }
            
            // Set layout mode
            function setLayoutMode(mode) {
                currentLayoutMode = mode;
                autoLayoutBtn.classList.remove('active');
                manualLayoutBtn.classList.remove('active');
                gridLayoutBtn.classList.remove('active');
                
                if (mode === 'auto') {
                    autoLayoutBtn.classList.add('active');
                    updateA4Template();
                } else if (mode === 'manual') {
                    manualLayoutBtn.classList.add('active');
                    enableManualLayout();
                } else if (mode === 'grid') {
                    gridLayoutBtn.classList.add('active');
                    updateGridLayout();
                }
            }
            
            // Enable manual layout mode
            function enableManualLayout() {
                photoContainer.innerHTML = '';
                draggablePhotos = [];
                
                const copiesCount = parseInt(copiesCountInput.value);
                const photoWidthMM = parseFloat(photoWidthInput.value);
                const photoHeightMM = parseFloat(photoHeightInput.value);
                
                // Add one photo centered by default
                const initialX = (210 - photoWidthMM) / 2;
                const initialY = (297 - photoHeightMM) / 2;
                
                const photoDiv = createDraggablePhoto(1, initialX, initialY, photoWidthMM, photoHeightMM);
                photoContainer.appendChild(photoDiv);
                
                draggablePhotos.push({
                    id: 1,
                    x: initialX,
                    y: initialY,
                    width: photoWidthMM,
                    height: photoHeightMM
                });
            }
            
            // Update grid layout (starting from top)
            function updateGridLayout() {
                photoContainer.innerHTML = '';
                draggablePhotos = [];
                
                const copiesCount = parseInt(copiesCountInput.value);
                const photoWidthMM = parseFloat(photoWidthInput.value);
                const photoHeightMM = parseFloat(photoHeightInput.value);
                const spacingMM = 2;
                
                // Calculate how many photos fit horizontally
                const photosPerRow = Math.floor(210 / (photoWidthMM + spacingMM));
                
                // Calculate margins to center the grid horizontally
                const totalWidth = photosPerRow * photoWidthMM + (photosPerRow - 1) * spacingMM;
                const leftMargin = (210 - totalWidth) / 2;
                
                // Fixed top margin (15mm from top)
                const topMargin = 15;
                const rowSpacing = 5;
                
                // Add photos in grid from top
                let photoId = 1;
                let currentTop = topMargin;
                
                while (photoId <= copiesCount) {
                    for (let col = 0; col < photosPerRow; col++) {
                        if (photoId > copiesCount) break;
                        
                        const x = leftMargin + col * (photoWidthMM + spacingMM);
                        const y = currentTop;
                        
                        const photoDiv = createDraggablePhoto(photoId, x, y, photoWidthMM, photoHeightMM);
                        photoContainer.appendChild(photoDiv);
                        
                        draggablePhotos.push({
                            id: photoId,
                            x,
                            y,
                            width: photoWidthMM,
                            height: photoHeightMM
                        });
                        
                        photoId++;
                    }
                    
                    // Move to next row
                    currentTop += photoHeightMM + rowSpacing;
                    
                    // Check if we have space for another row
                    if (currentTop + photoHeightMM > 297) break;
                }
            }
            
            // Update the A4 template with optimized layout
            function updateA4Template() {
                if (!resizedImageUrl) return;
                
                const copiesCount = parseInt(copiesCountInput.value);
                copiesCountDisplay.textContent = copiesCount;
                
                // Clear previous photos
                photoContainer.innerHTML = '';
                draggablePhotos = [];
                
                if (currentLayoutMode === 'auto') {
                    updateAutoLayout();
                } else if (currentLayoutMode === 'manual') {
                    enableManualLayout();
                } else if (currentLayoutMode === 'grid') {
                    updateGridLayout();
                }
            }
            
            // Update auto layout (optimized for paper usage)
            function updateAutoLayout() {
                const copiesCount = parseInt(copiesCountInput.value);
                const photoWidthMM = parseFloat(photoWidthInput.value);
                const photoHeightMM = parseFloat(photoHeightInput.value);
                
                // Calculate maximum number of photos that can fit in different orientations
                const landscapeCount = calculateMaxPhotos(photoWidthMM, photoHeightMM);
                const portraitCount = calculateMaxPhotos(photoHeightMM, photoWidthMM);
                
                // Use the orientation that fits more photos
                if (landscapeCount >= portraitCount) {
                    createAutoLayoutPhotos(photoWidthMM, photoHeightMM);
                } else {
                    createAutoLayoutPhotos(photoHeightMM, photoWidthMM, true);
                }
            }
            
            // Calculate maximum number of photos that can fit in given orientation
            function calculateMaxPhotos(width, height) {
                const a4Width = 210;
                const a4Height = 297;
                const spacing = 2;
                
                const horizontalFit = Math.floor(a4Width / (width + spacing));
                const verticalFit = Math.floor(a4Height / (height + spacing));
                
                return horizontalFit * verticalFit;
            }
            
            // Create photos in auto layout
            function createAutoLayoutPhotos(width, height, rotated = false) {
                const copiesCount = parseInt(copiesCountInput.value);
                const a4Width = 210;
                const a4Height = 297;
                const spacing = 2;
                
                // Calculate how many photos fit horizontally and vertically
                const horizontalFit = Math.floor(a4Width / (width + spacing));
                const verticalFit = Math.floor(a4Height / (height + spacing));
                const maxPerPage = horizontalFit * verticalFit;
                
                // Calculate margins to distribute space evenly
                const totalHorizontalSpace = horizontalFit * width + (horizontalFit - 1) * spacing;
                const leftMargin = (a4Width - totalHorizontalSpace) / 2;
                
                const totalVerticalSpace = verticalFit * height + (verticalFit - 1) * spacing;
                const topMargin = (a4Height - totalVerticalSpace) / 2;
                
                // Add photos in grid
                let photoId = 1;
                for (let row = 0; row < verticalFit; row++) {
                    for (let col = 0; col < horizontalFit; col++) {
                        if (photoId > copiesCount) break;
                        
                        const x = leftMargin + col * (width + spacing);
                        const y = topMargin + row * (height + spacing);
                        
                        const photoDiv = createDraggablePhoto(photoId, x, y, width, height);
                        if (rotated) {
                            photoDiv.style.transform = 'rotate(90deg)';
                            photoDiv.style.transformOrigin = 'center';
                        }
                        photoContainer.appendChild(photoDiv);
                        
                        draggablePhotos.push({
                            id: photoId,
                            x,
                            y,
                            width,
                            height,
                            rotated
                        });
                        
                        photoId++;
                    }
                }
            }
            
            // Create A4 template canvas
            async function createA4Canvas() {
                return new Promise((resolve) => {
                    // Create a new canvas for the A4 template
                    const a4Canvas = document.createElement('canvas');
                    const a4Ctx = a4Canvas.getContext('2d');
                    
                    // Set A4 dimensions at 300 DPI
                    const pxPerMM = 300 / 25.4;
                    a4Canvas.width = 210 * pxPerMM;
                    a4Canvas.height = 297 * pxPerMM;
                    
                    // Fill white background
                    a4Ctx.fillStyle = '#ffffff';
                    a4Ctx.fillRect(0, 0, a4Canvas.width, a4Canvas.height);
                    
                    // Load the resized image
                    const img = new Image();
                    img.onload = function() {
                        // Draw all photos from draggablePhotos array
                        draggablePhotos.forEach(photo => {
                            const x = photo.x * pxPerMM;
                            const y = photo.y * pxPerMM;
                            const width = photo.width * pxPerMM;
                            const height = photo.height * pxPerMM;
                            
                            if (photo.rotated) {
                                // Save the context
                                a4Ctx.save();
                                
                                // Move to center of where we want to draw
                                a4Ctx.translate(x + width/2, y + height/2);
                                
                                // Rotate
                                a4Ctx.rotate(Math.PI/2);
                                
                                // Draw the image offset by half its width/height
                                a4Ctx.drawImage(img, -height/2, -width/2, height, width);
                                
                                // Draw border
                                a4Ctx.strokeStyle = currentBorderColor;
                                a4Ctx.lineWidth = currentBorderSize * pxPerMM;
                                
                                // Set line dash pattern based on border type
                                if (currentBorderType === 'dashed') {
                                    a4Ctx.setLineDash([6, 3]);
                                } else if (currentBorderType === 'dotted') {
                                    a4Ctx.setLineDash([2, 2]);
                                } else {
                                    a4Ctx.setLineDash([]);
                                }
                                
                                a4Ctx.strokeRect(-height/2, -width/2, height, width);
                                a4Ctx.setLineDash([]); // Reset to solid line
                                
                                // Restore the context
                                a4Ctx.restore();
                            } else {
                                // Draw the image
                                a4Ctx.drawImage(img, x, y, width, height);
                                
                                // Draw border
                                a4Ctx.strokeStyle = currentBorderColor;
                                a4Ctx.lineWidth = currentBorderSize * pxPerMM;
                                
                                // Set line dash pattern based on border type
                                if (currentBorderType === 'dashed') {
                                    a4Ctx.setLineDash([6, 3]);
                                } else if (currentBorderType === 'dotted') {
                                    a4Ctx.setLineDash([2, 2]);
                                } else {
                                    a4Ctx.setLineDash([]);
                                }
                                
                                a4Ctx.strokeRect(x, y, width, height);
                                a4Ctx.setLineDash([]); // Reset to solid line
                            }
                        });
                        
                        resolve(a4Canvas);
                    };
                    img.src = resizedImageUrl;
                });
            }
            
            // Create DOCX document
            async function createDocx() {
                const { Document, Packer, Paragraph, ImageRun } = window.docx;
                
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = function() {
                        // Create a temporary canvas to get the image data
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = img.width;
                        tempCanvas.height = img.height;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(img, 0, 0);
                        
                        // Get image data URL
                        const imageDataUrl = tempCanvas.toDataURL('image/jpeg', 0.9);
                        
                        // Create document
                        const doc = new Document({
                            sections: [{
                                properties: {},
                                children: [
                                    new Paragraph({
                                        children: draggablePhotos.map(photo => {
                                            return new ImageRun({
                                                data: imageDataUrl,
                                                transformation: {
                                                    width: photo.width * 360, // 360 = 1mm in Word's units
                                                    height: photo.height * 360,
                                                },
                                                floating: {
                                                    horizontalPosition: {
                                                        offset: photo.x * 360,
                                                    },
                                                    verticalPosition: {
                                                        offset: photo.y * 360,
                                                    },
                                                }
                                            });
                                        })
                                    })
                                ]
                            }]
                        });
                        
                        resolve(doc);
                    };
                    img.src = resizedImageUrl;
                });
            }
            
            // Download as PDF
            async function downloadPDF() {
                if (!resizedImageUrl) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please resize a photo first', 'error');
                    return;
                }
                
                try {
                    const a4Canvas = await createA4Canvas();
                    
                    // Create PDF
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Add canvas image to PDF
                    pdf.addImage(a4Canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, 210, 297);
                    
                    // Download PDF
                    pdf.save('passport-photos-tech254.pdf');
                    showStatus('<i class="fas fa-check-circle"></i> PDF downloaded successfully!', 'success');
                } catch (error) {
                    console.error('PDF generation failed:', error);
                    showStatus('<i class="fas fa-exclamation-circle"></i> Failed to generate PDF', 'error');
                }
            }
            
            // Download as PNG
            async function downloadPNG() {
                if (!resizedImageUrl) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please resize a photo first', 'error');
                    return;
                }
                
                try {
                    const a4Canvas = await createA4Canvas();
                    
                    // Download PNG
                    const link = document.createElement('a');
                    link.download = 'passport-photos-tech254.png';
                    link.href = a4Canvas.toDataURL('image/png');
                    link.click();
                    showStatus('<i class="fas fa-check-circle"></i> PNG downloaded successfully!', 'success');
                } catch (error) {
                    console.error('PNG generation failed:', error);
                    showStatus('<i class="fas fa-exclamation-circle"></i> Failed to generate PNG', 'error');
                }
            }
            
            // Download as JPG
            async function downloadJPG() {
                if (!resizedImageUrl) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please resize a photo first', 'error');
                    return;
                }
                
                try {
                    const a4Canvas = await createA4Canvas();
                    
                    // Download JPG
                    const link = document.createElement('a');
                    link.download = 'passport-photos-tech254.jpg';
                    link.href = a4Canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    showStatus('<i class="fas fa-check-circle"></i> JPG downloaded successfully!', 'success');
                } catch (error) {
                    console.error('JPG generation failed:', error);
                    showStatus('<i class="fas fa-exclamation-circle"></i> Failed to generate JPG', 'error');
                }
            }
            
            // Download as DOCX
            async function downloadDOCX() {
                if (!resizedImageUrl) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please resize a photo first', 'error');
                    return;
                }
                
                try {
                    const doc = await createDocx();
                    
                    // Generate DOCX file
                    const packer = new Packer();
                    const blob = await packer.toBlob(doc);
                    
                    // Download DOCX
                    const link = document.createElement('a');
                    link.download = 'passport-photos-tech254.docx';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    
                    // Clean up
                    setTimeout(() => {
                        URL.revokeObjectURL(link.href);
                    }, 100);
                    
                    showStatus('<i class="fas fa-check-circle"></i> DOCX downloaded successfully!', 'success');
                } catch (error) {
                    console.error('DOCX generation failed:', error);
                    showStatus('<i class="fas fa-exclamation-circle"></i> Failed to generate DOCX', 'error');
                }
            }
            
            // Print A4 template
            function printDocument() {
                if (!resizedImageUrl) {
                    showStatus('<i class="fas fa-exclamation-circle"></i> Please resize a photo first', 'error');
                    return;
                }
                window.print();
            }
            
            // Toggle dark mode
            function toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                }
            }
            
            // Show help modal
            function showHelp() {
                alert("Passport Photo Sizer Tool Help:\n\n" +
                    "1. Upload your photo by clicking the upload area or dragging a file\n" +
                    "2. Set the desired dimensions for your passport photo\n" +
                    "3. Use the Crop Tool if you need to adjust the composition\n" +
                    "4. Click 'Resize Photo' to apply the changes\n" +
                    "5. Choose a layout mode (Auto, Manual, or Grid)\n" +
                    "6. Download or print your formatted passport photos\n\n" +
                    "Additional features:\n" +
                    "-Meta TECH Background Removal (simulated)\n" +
                    "- Custom border settings\n" +
                    "- Multiple export formats (PDF, PNG, JPG, DOCX)\n" +
                    "- Dark mode toggle in the top right corner");
            }
            
            // Initialize the application
            init();
        });
    </script>
</body>
</html>
